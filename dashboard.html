<!DOCTYPE html>
<html>
<head>
    <title>Couples Chat Journal</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
<div class="container">
    <h1>ðŸ’‘ Couple Chat Journal</h1>
    <div id="chatWindow" class="chat-window"></div>
    <textarea id="entry" placeholder="Write something..." rows="1"></textarea>
    <button onclick="addEntry()">Send</button>
    <p>Your partner code: <span id="partnerCode"></span></p>
    <button onclick="logout()" style="margin-top:10px;">Logout</button>
</div>

<style>
.chat-window {
    background: #f5f5f5;
    border-radius: 10px;
    height: 300px;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
}

.bubble {
    max-width: 70%;
    padding: 10px;
    border-radius: 15px;
    margin: 5px 0;
    word-wrap: break-word;
}

.self {
    background: #ff7e5f;
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 0;
}

.partner {
    background: #4ebaaa;
    color: white;
    align-self: flex-start;
    border-bottom-left-radius: 0;
}

textarea {
    width: calc(100% - 80px);
    padding: 8px;
    border-radius: 10px;
    resize: none;
    border: 1px solid #ccc;
    font-size: 14px;
}

button {
    padding: 8px 12px;
    border-radius: 10px;
    border: none;
    background: #ff7e5f;
    color: white;
    cursor: pointer;
}

button:hover {
    background: #ff6b4a;
}
</style>

<script>
const username = localStorage.getItem("user");
if(!username) window.location="login.html";

const entryBox = document.getElementById("entry");
entryBox.addEventListener("input", () => {
    entryBox.style.height = "auto";
    entryBox.style.height = entryBox.scrollHeight + "px";
});

entryBox.addEventListener("keypress", function(e){
    if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        addEntry();
    }
});

async function loadJournal(){
    const data = await apiGet(`/api/journal?username=${username}`);
    const chat = document.getElementById("chatWindow");
    chat.innerHTML = "";
    if(data.journal){
        data.journal.forEach(e => {
            const bubble = document.createElement("div");
            bubble.classList.add("bubble");
            if(e.startsWith(username+":")){
                bubble.classList.add("self");
                bubble.innerText = e.replace(username+": ","");
            } else if(e.includes(":")) {
                bubble.classList.add("partner");
                bubble.innerText = e;
            } else {
                bubble.classList.add("self");
                bubble.innerText = e;
            }
            chat.appendChild(bubble);
        });
        chat.scrollTop = chat.scrollHeight;
    }
}

async function addEntry(){
    const entry = entryBox.value.trim();
    if(!entry) return;
    await apiPost("/api/journal",{username, entry});
    entryBox.value = "";
    entryBox.style.height = "auto";
    loadJournal();
}

function logout(){ localStorage.removeItem("user"); window.location="login.html"; }

loadJournal();
setInterval(loadJournal, 5000); // refresh every 5 seconds
</script>
</body>
</html>
